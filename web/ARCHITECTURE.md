# Excel Copilot 架构设计

## 整体架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   React 前端    │    │  Rust 后端      │    │  OpenAI API     │
│                 │    │                 │    │                 │
│ - Excel处理     │    │ - AI聊天代理    │◄──►│ - 聊天完成      │
│ - 聊天界面      │◄──►│ - 流式响应处理  │    │ - 流式响应      │
│ - 设置管理      │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 前端架构 (React)

### 组件结构
```
App
├── ExcelViewer
│   ├── 文件上传 (前端处理)
│   ├── 工作表选择
│   └── 数据表格显示
├── ChatInterface
│   ├── 消息历史
│   ├── 输入框
│   └── 流式响应处理
└── SettingsModal
    ├── OpenAI配置
    └── 设置保存
```

### 关键特性
- **响应式设计**: 支持桌面和移动设备
- **实时流式响应**: 支持AI响应的实时显示
- **Excel文件处理**: 客户端Excel文件解析和显示
- **状态管理**: React Hooks进行状态管理

## 后端架构 (Rust + Actix Web)

### 服务结构
```
handlers/
├── chat_handler.rs      # 聊天请求处理
└── health_handler.rs    # 健康检查

services/
└── openai_service.rs    # OpenAI API集成

models/
└── 数据模型定义
```

### 关键特性
- **异步处理**: 基于Tokio的异步运行时
- **流式响应**: 支持Server-Sent Events
- **AI代理**: OpenAI API集成和流式响应处理
- **错误处理**: 统一的错误处理机制

## 数据流

### 1. Excel文件处理流程
```
用户选择文件 → 前端解析 → 显示表格 → 提取文本数据 → 准备聊天数据
```

### 2. AI聊天流程
```
用户输入 → 前端收集消息 → 后端添加系统提示 → OpenAI API → 流式响应 → 前端实时显示
```

### 3. 流式响应处理
```
OpenAI API → 后端接收流 → 解析SSE格式 → 转发到前端 → 实时渲染
```

## API设计

### RESTful API
- `POST /api/chat` - 聊天请求
- `GET /api/health` - 健康检查

### 流式响应
- 使用Server-Sent Events (SSE)
- 支持OpenAI的流式响应格式
- 实时传输聊天内容

## 部署架构

### Docker容器化
```
┌─────────────────┐
│   Nginx 反向代理 │
└─────────┬───────┘
          │
    ┌─────┴─────┐
    │           │
┌───▼───┐   ┌───▼───┐
│ 前端  │   │ 后端  │
│React │   │Rust   │
└──────┘   └───────┘
```

### 环境配置
- **开发环境**: 本地Docker Compose
- **生产环境**: 支持云平台部署
- **配置管理**: 环境变量和配置文件

## 安全考虑

### 前端安全
- 输入验证和清理
- XSS防护
- CORS配置

### 后端安全
- 请求验证
- 文件类型检查
- API密钥管理
- 错误信息过滤

## 性能优化

### 前端优化
- 组件懒加载
- 虚拟滚动 (大数据表格)
- 缓存策略

### 后端优化
- 异步处理
- 连接池
- 内存管理
- 流式处理

## 扩展性设计

### 水平扩展
- 无状态后端设计
- 负载均衡支持
- 数据库分离

### 功能扩展
- 插件化架构
- 多AI提供商支持
- 更多文件格式支持

## 监控和日志

### 日志系统
- 结构化日志
- 不同级别日志
- 请求追踪

### 监控指标
- API响应时间
- 错误率
- 资源使用情况

## 开发工作流

### 代码管理
- Git版本控制
- 分支策略
- 代码审查

### 测试策略
- 单元测试
- 集成测试
- E2E测试

### CI/CD
- 自动化构建
- 自动化测试
- 自动化部署
